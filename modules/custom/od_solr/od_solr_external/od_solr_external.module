<?php

/**
 * @file
 * Contains od_solr_external.module.
 */

use Drupal\search_api\Query\QueryInterface;
use Drupal\views\ViewExecutable;
use Solarium\QueryType\Select\Query\Query as SolariumQuery;

/**
 * Implements hook_search_api_solr_query_alter().
 */
function od_solr_external_search_api_solr_query_alter(SolariumQuery $solarium_query, QueryInterface $query) {
  // Do not alter the query if the index does not use the solr_document
  // datasource.
  $index = $query->getIndex();
  if (!$index->isValidDatasource('solr_document')) {
    return;
  }

  // Language handling.
  $language = Drupal::languageManager()->getCurrentLanguage();

  if ($index->id() == 'pd_core_ati') {
    $solarium_query->createFilterQuery('od_solr_external_language')->setQuery('ss_language:' . $language->getId());
  }

}

/**
 * Implements hook_views_pre_render().
 */
function od_solr_external_views_pre_render(ViewExecutable $view) {
  $cores = [
    'pd_core_ati' => ['block_1', 'block_2'],
    'pd_core_contracts' => ['block_1', 'block_2'],
    'pd_core_hospitalityq' => ['block_1', 'block_2'],
    'pd_core_inventory' => ['block_1', 'block_2'],
    'pd_core_reclassification' => ['block_1', 'block_2'],
    'pd_core_travela' => ['block_1', 'block_2'],
    'pd_core_travelq' => ['block_1', 'block_2'],
    'pd_core_wrongdoing' => ['block_1', 'block_2'],
  ];

  foreach ($cores as $core => $coreDisplay) {

    if ($view->id() == $core &&  in_array($view->current_display, $coreDisplay)) {
      /** @var \Drupal\Core\Language\LanguageManagerInterface $language_manager */
      $language_manager = \Drupal::service('language_manager');
      $currentLang = $language_manager->getCurrentLanguage()->getId();
      $defaultLang = $language_manager->getDefaultLanguage()->getId();
      if ($defaultLang != $currentLang) {
        if (!empty($view->style_plugin->options['panel_title_field'])) {
          $view->style_plugin->options['panel_title_field'] = str_replace('_' . $defaultLang, '_' . $currentLang, $view->style_plugin->options['panel_title_field']);
        }
      }
      foreach ($view->field as $field) {
        if ($defaultLang != $currentLang) {
          if (strpos($field->field, '_' . $defaultLang) !== FALSE) {
            unset($view->field[$field->field]);
          }
        }
        else {
          if (strpos($field->field, '_fr') !== FALSE) {
            unset($view->field[$field->field]);
          }
        }
      }
    }
  }
}
